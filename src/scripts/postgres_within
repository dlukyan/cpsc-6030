#!/bin/bash
cat /mnt/$1 | sed 1d > /mnt/$1_headless.csv
psql -U postgres -c "create role dvproject login password 'password';"
psql -U postgres -c "create database dvproject;"
psql -U postgres -c "alter database dvproject owner to dvproject;"
psql -U postgres -d dvproject -c "create schema dvproject; alter schema dvproject owner to dvproject;"
psql -U postgres -d dvproject -c "set search_path to dvproject; create table data (name varchar(1024), age int, gender varchar(32), race varchar(128), victim_image text, date date, street_address varchar(1024), city varchar(128), state varchar(4), zip varchar(8), county varchar(128), agency_responsible varchar(256), ori varchar(128), cause_of_death varchar(128), circumstances varchar(4096), disposition_official varchar(1024), officer_charged varchar(128), news_url varchar(4096), signs_of_mental_illness varchar(64), allegedly_armed varchar(128), wapo_armed varchar(128), wapo_threat_level varchar(128), wapo_flee varchar(32), wapo_body_camera varchar(32), wapo_id int, off_duty_killing varchar(64), georgaphy varchar(64), mpv_id int, fe_id int, encounter_type varchar(128), initial_reason varchar(4096), officer_names varchar(4096), officer_races varchar(256), officer_known_past_shootings varchar(4096), call_for_service varchar(16), tract int, urban_rural_upsai varchar(32), urban_rural_nchs varchar(32), hhincome_median_census_tract int, latitude float, longitude float, pop_total_census_tract float, pop_white_census_tract float, pop_black_census_tract float, pop_native_american_census_tract float, pop_asian_census_tract float, pop_pacific_islander_census_tract float, pop_other_multiple_census_tract float, pop_hispanic_census_tract float, congressional_district_113 varchar(8), congressperson_lastname varchar(128), congressperson_firstname varchar(128), congressperson_party varchar(32), prosecutor_head varchar(128), prosecutor_race varchar(16), prosecutor_gender varchar(128), prosecutor_party varchar(128), prosecutor_term varchar(128), prosecutor_in_court varchar(128), prosecutor_special varchar(128), independent_investigation varchar(128), prosecutor_url varchar(4096)); copy data from '/mnt/police_violence_cleaned_headless.csv' with (format csv);"
psql -U postgres -d dvproject -c "set search_path to dvproject; create table census_2010_2019 (state  varchar(128) not null, \"2010\" integer not null, \"2011\" integer not null, \"2012\" integer not null, \"2013\" integer not null, \"2014\" integer not null, \"2015\" integer not null, \"2016\" integer not null, \"2017\" integer not null, \"2018\" integer not null, \"2019\" integer not null); copy census_2010_2019 from '/mnt/census-2013-2019_headless.csv' with (format csv);"
psql -U postgres -d dvproject -c "set search_path to dvproject; create table census_2020 (rank float not null, state varchar(64) not null, state_code varchar(4) not null, population integer not null, percent float not null); copy census_2020 from '/mnt/census-2020_headless.csv' with (format csv);"
psql -U postgres -d dvproject -c "set search_path to dvproject; create table census_2021 (state_code varchar(4) not null, \"2021\" integer not null);"
psql -U postgres -d dvproject -c "set search_path to dvproject; create table census as (select c19.state as state, c19.state_code as state_code, c19.\"2013\" as \"2013\", c19.\"2014\" as \"2014\", c19.\"2015\" as \"2015\", c19.\"2016\" as \"2016\", c19.\"2017\" as \"2017\", c19.\"2018\" as \"2018\", c19.\"2019\" as \"2019\", c20.population as \"2020\", c21.\"2021\" as \"2021\" from census_2010_2019 c19 left join census_2020 c20 on c20.state_code = c19.state_code left join census_2021 c21 on c21.state_code = c19.state_code);"
psql -U postgres -d dvproject -c "grant all privileges on all tables in schema dvproject to dvproject;"
psql -U postgres -d dvproject -c "set search_path to dvproject; create table data_cleaned as (select name, age, gender, race, date, street_address, city, state, zip, county, ori, cause_of_death, disposition_official, officer_charged, signs_of_mental_illness, allegedly_armed, wapo_armed, wapo_threat_level, wapo_flee, wapo_body_ccamera, wapo_id, off_duty_killing, georgaphy, mpv_id, fe_id, officer_races, call_for_service, tract, urban_rural_upsai, hhincome_median_census_tract, latitude, longitude, pop_total_census_tract, pop_white_census_tract, pop_black_census_tract pop_native_american_census_tract, pop_asian_census_tract, pop_pacific_islander_census_tract, pop_other_multiple_census_tract, pop_hispanic_census_tract, congressperson_party, prosecutor_gender, prosecutor_race, prosecutor_party from data where longitude is not null and latitude is not null and age is not null and hhincome_median_census_tract is not null and gender is not nul and gender != 'Transgender' and gender != 'Unknown' and congressperson_party is not null and wapo_body_ccamera is not null and wapo_threat_level is not null and wapo_threat_level != 'Other' and wapo_threat_level != 'Unclear' and wapo_threat_level != 'Undetermined' and wapo_flee is not null and wapo_flee != 'Other' and date < '2022-01-01')"